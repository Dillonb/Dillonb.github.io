<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>AWS ECS IAM Roles: Demystified | Dillon Beliveau</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="AWS ECS IAM Roles: Demystified" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Blog of a software engineer in Vermont." />
<meta property="og:description" content="Blog of a software engineer in Vermont." />
<link rel="canonical" href="http://localhost:4000/2018/12/08/aws-ecs-iam-roles-demystified.html" />
<meta property="og:url" content="http://localhost:4000/2018/12/08/aws-ecs-iam-roles-demystified.html" />
<meta property="og:site_name" content="Dillon Beliveau" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-12-08T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Blog of a software engineer in Vermont.","@type":"BlogPosting","url":"http://localhost:4000/2018/12/08/aws-ecs-iam-roles-demystified.html","dateModified":"2018-12-08T00:00:00-05:00","datePublished":"2018-12-08T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018/12/08/aws-ecs-iam-roles-demystified.html"},"headline":"AWS ECS IAM Roles: Demystified","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Dillon Beliveau" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Dillon Beliveau</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">AWS ECS IAM Roles: Demystified</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-12-08T00:00:00-05:00" itemprop="datePublished">Dec 8, 2018
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
     <p>To run tasks in ECS, up to four different roles are required. Which ones you need depends on a variety of factors. Probably the most frustrating thing for me when getting started with ECS was confusion around which of these roles needed what permissions, the purpose of each of them, how to create them, what components of the system used them, and where to configure them. This post does not attempt to be a complete introduction or reference to ECS in general, just a source to hopefully clear up confusion around IAM and ECS.</p>
<h2>Role Types</h2>
<h3>Host Role</h3>
<p>When running ECS on EC2, the EC2 instances hosting the containers need a role. This role gives them permission to, among other things, pull images from ECR, manage tasks in the ECS API, and put logs into cloudwatch.</p>
<h3>Task Execution Role</h3>
<p>When running in Fargate, there are no EC2 instances hosting your containers, so these permissions have to go somewhere. This is called a <i>Task Execution Role.</i> It gives the Fargate service the same permissions the EC2 instance would need. This role is <i>not</i> required when running tasks on EC2 backed ECS.</p>
<h3>ECS Service-Linked Role</h3>
<p>This is a role used by the ECS service itself to perform functions such as managing load balancer configuration, doing service discovery, as well as attaching network interfaces when using the `awsvpc` network mode.
  There is only one of these per account.</p>
<h3>ECS Task Role (or Container Role)</h3>
<p>Not to be confused with the Task <i>Execution</i> Role, the Task Role is used when code running inside the container needs access to AWS resources. This is equivalent to the instance profile if the code was running directly on an EC2 instance.</p>
<h2>Creating the Required Roles in an ALKS-Controlled Account</h2>
<p>At my company, we use a tool called ALKS to manage access to and permissions in our AWS accounts. We open sourced a <a href="https://github.com/Cox-Automotive/terraform-provider-alks">Terraform provider</a> for it, and that&#8217;s what my examples will be using. If needed, find another source for how to create the roles and use these examples for information on what policies to attach.</p>
<h3>Host Role</h3>
<p>This will be a standard IAM Role. First create the role itself:</p>
<pre class="src" lang="terraform">
resource &quot;alks_iamrole&quot; &quot;ecs_host&quot; {
  name                     = &quot;ecs-host-role&quot;
  type                     = &quot;Amazon EC2&quot;
  include_default_policies = false
}
</pre>
<p>If you use multiple clusters, you can prefix it with the name of your cluster, creating a `flume-ecs-host-role` for example.</p>
<p>Then attach the required policy:</p>
<pre class="src" lang="terraform">
resource &quot;aws_iam_role_policy_attachment&quot; &quot;ecs_host_ecs_attachment&quot; {
  role       = &quot;${alks_iamrole.ecs_host.name}&quot;
  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role&quot;
}
</pre>
<p>This is an AWS Managed policy, so there&#8217;s no need to create it.</p>
<h3>Task Execution Role</h3>
<p>Create a role with the type &#8220;Amazon EC2 Container Service Task Role&#8221; and attach the AWS provided policy to it.</p>
<pre class="src" lang="terraform">
resource &quot;alks_iamrole&quot; &quot;task_execution_role&quot; {
  name                     = &quot;ecsTaskExecutionRole&quot;
  type                     = &quot;Amazon EC2 Container Service Task Role&quot;
  include_default_policies = false
}

resource &quot;aws_iam_role_policy_attachment&quot; &quot;task_execution_attachment&quot; {
  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&quot; // AWS provided policy
  role       = &quot;${alks_iamrole.task_execution_role.name}&quot;
}
</pre>
<h3>Service Linked Role</h3>
<p>Normally, this role would be created automatically the first time it&#8217;s needed. However, if your account is as locked down as my account at work is, you&#8217;ll need to create it manually from a privileged login.</p>
<p>Provide the AWS cli with credentials that have permission to create roles, and run:</p>
<pre class="src" lang="bash">
$ aws iam create-service-linked-role --aws-service-name ecs.amazonaws.com
</pre>
<p>This only needs to be run once per account. Once the role is created you&#8217;ll never have to worry about it again, and you won&#8217;t even have to refer to it in any Terraform or other configuration. The ECS service will just use it if it exists.</p>
<h3>Task Role</h3>
<p>Create a role as normal, but give it the type of &#8220;Amazon EC2 Container Service Task Role&#8221;</p>
<pre class="src" lang="terraform">
resource &quot;alks_iamrole&quot; &quot;config_services_container&quot; {
  name                     = &quot;application-name-container-role&quot;
  type                     = &quot;Amazon EC2 Container Service Task Role&quot;
  include_default_policies = false
} 
</pre>
<p>There are no required attachments or other settings here. Just name it something that makes sense and attach the policies you need to it.</p>
<h3>What about through the UI?</h3>
<p>While it&#8217;s certainly possible to do all this through the UI, I highly recommend using a tool like Terraform to manage configuration and permissions.</p>
<p>Create the roles with the correct &#8220;type&#8221; in the UI, and attach the required policies to them. You should use Terraform though.</p>
<h2>Terraforming Services and Tasks</h2>
<p>Here&#8217;s a quick overview of which roles go where when terraforming resources. The Terraform documentation is very good for the properties I&#8217;m leaving out. See docs for <a href="https://www.terraform.io/docs/providers/aws/r/instance.html">EC2 instance</a> and <a href="https://www.terraform.io/docs/providers/aws/r/ecs_task_definition.html">ECS task definition</a>.</p>
<pre class="src" lang="terraform">
resource &quot;aws_instance&quot; &quot;ecs_host_instance&quot; {
  iam_instance_profile = &quot;${var.host_role_name}&quot; // This is the Host Role, applied to the cluster instances. This is required to allow your host access to manage tasks.
}

resource &quot;aws_ecs_task_definition&quot; &quot;ecs_task_definition&quot; {
  execution_role_arn = &quot;${var.task_execution_role_arn}&quot; // This is the Task Execution Role, only required on Fargate. Called &quot;ecsTaskExecutionRole&quot; above.
  task_role_arn      = &quot;${var.container_role_arn}&quot; // This is the Task Role, or Container Role. This is required only if code running in your container needs access to AWS services.
}
</pre>
<h2>Which IAM Role will my code run as?</h2>
<p>Assuming your code is using a recent version of the AWS SDK with the default credentials provider chain, i.e. not explicitly specifying where credentials are coming from, it will first attempt to get credentials from the <i>ECS Task Role</i>. If that fails, it will fall back to the <i>Host Role</i>.</p>
<p>Note: Certain versions of Hadoop and services running on top of it like Flume, for example, will pull in the <i>Host Role</i> no matter what. If, like on Fargate, there is no Host Role, Flume will not be able to find credentials.</p>
<h3>Sources:</h3>
<ul>
  <li>https://serverfault.com/questions/854413/confused-by-the-role-requirement-of-ecs/854467#854467</li>
  <li>https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html</li>
  <li>https://docs.aws.amazon.com/AmazonECS/latest/developerguide/instance_IAM_role.html</li>
  <li>https://github.com/Cox-Automotive/terraform-provider-alks/blob/master/README.md</li>
</ul>
 
  </div><a class="u-url" href="/2018/12/08/aws-ecs-iam-roles-demystified.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Dillon Beliveau</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Dillon Beliveau</li><li><a class="u-email" href="mailto:dillonbeliveau@gmail.com">dillonbeliveau@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/Dillonb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Dillonb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Blog of a software engineer in Vermont.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
